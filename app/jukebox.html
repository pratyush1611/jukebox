<!doctype html>
<meta name=viewport content="width=device-width, initial-scale=1">
<title>Wi-Fi Jukebox</title>
<style>
 body{font-family:system-ui,Arial;max-width:800px;margin:24px auto;padding:0 12px}
 #now{padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:12px}
 li{display:flex;align-items:center;gap:8px;margin:6px 0}
 button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#f5f5f5;cursor:pointer}
 input[type=text]{width:70%;padding:8px}
 input[type=range]{width:100%;margin:8px 0}
 small{color:#666}
 #progress{display:flex;align-items:center;gap:8px;margin:8px 0}
</style>
<div id=now><i>Nothing playing</i></div>
<div>
  <input id=q placeholder="YouTube link or search‚Ä¶" autofocus onkeydown="if(event.key==='Enter'){add(this.value,false);this.value=''}">
  <button onclick="const q=document.getElementById('q'); add(q.value,true); q.value=''">Play Next</button>
  <button onclick="const q=document.getElementById('q'); add(q.value,false); q.value=''">Add to Queue</button>
</div>
<div style="margin:10px 0">
  <label><input type="checkbox" id="allowAgeRestricted"> Allow age-restricted content</label>
</div>
<ul id=list></ul>
<script>
async function j(url,method='GET',body=null){
  const o={method,headers:{'Content-Type':'application/json'}};
  if(body) o.body=JSON.stringify(body);
  const r=await fetch(url,o); return r.json();
}
async function refresh(){
  const s=await j('/queue'); const n=document.getElementById('now');
  if(s.now){
    const pos = s.now.position || 0; const dur = s.now.duration || 0;
    const fmt = t => `${Math.floor(t/60)}:${String(Math.floor(t%60)).padStart(2,'0')}`;
    const isPaused = s.now.paused || false;
    const playPauseBtn = isPaused ? 
      `<button onclick="post('/play')">‚ñ∂Ô∏è</button>` : 
      `<button onclick="post('/pause')">‚è∏Ô∏è</button>`;
    n.innerHTML = `<b>Now:</b> ${s.now.title} <small>by ${s.now.uploader}</small>
      <div id=progress><span>${fmt(pos)}</span><input type=range id=seek min=0 max=${dur} value=${pos}><span>${fmt(dur)}</span></div>
      <div style="margin-top:8px">
        ${playPauseBtn}
        <button onclick="post('/skip')">‚è≠Ô∏è</button>
      </div>`;
    document.getElementById('seek').oninput = e => post('/seek', {pos: e.target.value});
  } else {
    n.innerHTML = `<i>Nothing playing</i>
      <div style="margin-top:8px">
        <button onclick="post('/play')">‚ñ∂Ô∏è</button>
        <button onclick="post('/skip')">‚è≠Ô∏è</button>
      </div>`;
  }
  const ul=document.getElementById('list'); ul.innerHTML='';
  let autoplayStarted = false;
  (s.queue||[]).forEach((it,i)=>{
    // Add separator before first autoplay song
    if(!autoplayStarted && it.added_by === 'autoplay'){
      const separator = document.createElement('li');
      separator.innerHTML = '<hr style="margin:10px 0;border:1px dashed #ccc;"><small style="color:#999;font-style:italic;">üéµ Auto-suggested songs</small>';
      separator.style.listStyle = 'none';
      ul.appendChild(separator);
      autoplayStarted = true;
    }
    const li=document.createElement('li');
    const icon = it.added_by === 'autoplay' ? 'üéµ' : 'üë§';
    const duration = it.duration ? `${Math.floor(it.duration/60)}:${String(Math.floor(it.duration%60)).padStart(2,'0')}` : '';
    li.innerHTML=`<span style="flex:1">${icon} ${i+1}. ${it.title} <small>by ${it.uploader} ${duration ? `‚Ä¢ ${duration}` : ''} ‚Äî #${it.id}</small></span>`;
    if(it.added_by === 'autoplay') li.style.opacity = '0.7';
    ul.appendChild(li);
  });
}
async function post(u,body){ await j(u,'POST',body); refresh(); }
async function add(q, playNext){
  if(!q.trim()) return;
  const allowAgeRestricted = document.getElementById('allowAgeRestricted').checked;
  const r = await j('/add','POST',{q, play_next: playNext, allow_age_restricted: allowAgeRestricted});
  if(r.ok) refresh();
  else alert('Error: ' + (r.error || 'unknown'));
}
setInterval(refresh,2000); refresh();
</script>
